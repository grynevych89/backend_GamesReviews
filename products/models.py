from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from django_ckeditor_5.fields import CKEditor5Field
from slugify import slugify
from django.contrib.sites.models import Site
from django.utils.html import format_html
from django.utils.safestring import mark_safe


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üìö Supporting Models
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Category(models.Model):
    name = models.CharField("Category Name", max_length=100, unique=True, help_text="–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, –Ω–∞–ø—Ä. Action, RPG")
    def __str__(self): return self.name

class Language(models.Model):
    name = models.CharField("Language", max_length=100, unique=True)
    def __str__(self): return self.name

class Type(models.Model):
    name = models.CharField("Type Name", max_length=100, unique=True, help_text="–¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç—É: Game, Movie –∞–±–æ App")
    def __str__(self): return self.name

class Genre(models.Model):
    name = models.CharField("Genre Name", max_length=100, unique=True)
    def __str__(self): return self.name

class StorePlatform(models.Model):
    name = models.CharField("Platform Name", max_length=100, unique=True)
    icon_url = models.URLField("Icon URL", help_text="–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ–∫–æ–Ω–∫—É (SVG/PNG)")
    store_url = models.URLField("Store URL", blank=True, null=True, help_text="–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω—ñ (Steam, Epic —ñ —Ç.–¥.)")
    def __str__(self): return self.name

class Company(models.Model):
    name = models.CharField("–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó", max_length=255, unique=True)
    def __str__(self): return self.name

class FAQ(models.Model):
    question = models.CharField("Question", max_length=255, help_text="–ü–∏—Ç–∞–Ω–Ω—è")
    answer = models.TextField("Answer", help_text="–í—ñ–¥–ø–æ–≤—ñ–¥—å")
    def __str__(self): return self.question

class Poll(models.Model):
    question = models.CharField("Poll Question", max_length=255, help_text="–ü–∏—Ç–∞–Ω–Ω—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è")
    def __str__(self): return self.question

class PollOption(models.Model):
    poll = models.ForeignKey(Poll, on_delete=models.CASCADE, related_name="options")
    text = models.CharField("Option Text", max_length=100, help_text="–í–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ")
    def __str__(self): return f"{self.text} (Poll: {self.poll.question})"

class Author(models.Model):
    name = models.CharField("–Ü–º‚Äô—è –∞–≤—Ç–æ—Ä–∞", max_length=100, unique=True)
    def __str__(self): return self.name

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üéÆ Product Model
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Product(models.Model):
    # Basic
    site = models.ForeignKey(Site, on_delete=models.CASCADE, verbose_name="Sites", help_text="–ù–∞ —è–∫–æ–º—É —Å–∞–π—Ç—ñ –±—É–¥–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—å")
    title = models.CharField("Product Title", max_length=255, help_text="–ù–∞–∑–≤–∞")
    slug = models.SlugField("Slug", unique=True, help_text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∑—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∞")
    steam_id = models.CharField("Steam ID", max_length=50, blank=True, null=True, help_text="Steam ID (–¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É)")
    is_active = models.BooleanField("Is Active?", default=True, help_text="–Ø–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω–æ ‚Äî –≥—Ä–∞ –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ")
    type = models.ForeignKey(Type, on_delete=models.SET_NULL, null=True, blank=True, related_name="products", verbose_name="–¢–∏–ø", help_text="–û–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω —Ç–∏–ø")
    category = models.ForeignKey(Category, on_delete=models.SET_NULL, null=True, blank=True, related_name="products", verbose_name="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", help_text="–û–±–µ—Ä—ñ—Ç—å –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é")
    author = models.ForeignKey(Author, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Author", help_text="–ê–≤—Ç–æ—Ä, —è–∫–∏–π –¥–æ–¥–∞–≤ –≥—Ä—É")

    # Description & Metadata
    short_description = models.TextField("Short Description", blank=True, help_text="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å (–¥–æ 300 —Å–∏–º–≤–æ–ª—ñ–≤)")
    description = CKEditor5Field("Full Description", blank=True, help_text="–ü–æ–≤–Ω–∏–π –æ–ø–∏—Å –≥—Ä–∏ –∑ HTML-—Ä–æ–∑–º—ñ—Ç–∫–æ—é (–ø–∞—Ä—Å–∏–Ω–≥ –∑—ñ Steam)")
    required_age = models.PositiveIntegerField("Required Age", default=0, help_text="–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –≤—ñ–∫ –¥–ª—è –≥—Ä–∏")
    release_date = models.DateField("Release Date", blank=True, null=True, help_text="–û—Ñ—ñ—Ü—ñ–π–Ω–∞ –¥–∞—Ç–∞ —Ä–µ–ª—ñ–∑—É –≥—Ä–∏")
    website = models.URLField("–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∞–π—Ç", blank=True, null=True, help_text="–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∞–π—Ç –≥—Ä–∏")

    # Genres & Tags
    genres = models.ManyToManyField(Genre, blank=True, help_text="–ñ–∞–Ω—Ä–∏ –∑ Steam: Indie, Multiplayer, Sports —Ç–æ—â–æ.")
    languages = models.ManyToManyField(Language, blank=True, help_text="–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ –º–æ–≤–∏")
    store_platforms = models.ManyToManyField(StorePlatform, related_name="products", blank=True, help_text="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∏, –¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç (Steam, Epic, GOG)")
    developers = models.ManyToManyField(Company, related_name="developed_products", blank=True)
    publishers = models.ManyToManyField(Company, related_name="published_products", blank=True)

    # Platform Support
    platform_windows = models.BooleanField("Windows", default=False)
    platform_mac = models.BooleanField("macOS", default=False)
    platform_linux = models.BooleanField("Linux", default=False)

    # System Requirements ‚Äî Min
    min_os = models.CharField("Minimum OS", max_length=100, blank=True)
    min_processor = models.CharField("Minimum Processor", max_length=100, blank=True)
    min_ram = models.CharField("Minimum RAM", max_length=50, blank=True)
    min_graphics = models.CharField("Minimum Graphics Card", max_length=150, blank=True)
    min_storage = models.CharField("Minimum Storage", max_length=50, blank=True)
    min_additional = models.CharField("Minimum Additional Info", max_length=200, blank=True)

    # System Requirements ‚Äî Recommended
    rec_os = models.CharField("Recommended OS", max_length=100, blank=True)
    rec_processor = models.CharField("Recommended Processor", max_length=100, blank=True)
    rec_ram = models.CharField("Recommended RAM", max_length=50, blank=True)
    rec_graphics = models.CharField("Recommended Graphics Card", max_length=150, blank=True)
    rec_storage = models.CharField("Recommended Storage", max_length=50, blank=True)
    rec_additional = models.CharField("Recommended Additional Info", max_length=200, blank=True)

    # Pricing
    is_free = models.BooleanField("Free to Play?", default=False)
    price_initial = models.PositiveIntegerField("Initial Price (in cents)", blank=True, null=True)
    price_final = models.PositiveIntegerField("Final Price (in cents)", blank=True, null=True)
    discount_percent = models.PositiveIntegerField("–ó–Ω–∏–∂–∫–∞ (%)", blank=True, null=True, validators=[MinValueValidator(0), MaxValueValidator(100)])
    currency = models.CharField("–í–∞–ª—é—Ç–∞", max_length=10, blank=True)

    # Ratings
    rating_manual = models.DecimalField("Manual Rating", max_digits=2, decimal_places=1, validators=[MinValueValidator(0), MaxValueValidator(5)])
    rating_external = models.DecimalField("External Rating", max_digits=2, decimal_places=1, blank=True, null=True)

    # Review Content
    review = models.BooleanField("Review", default=False)
    review_headline = models.CharField("Review Title(H1)", max_length=255)
    review_body = CKEditor5Field("Review Body")
    pros = models.TextField("Pros", blank=True)
    cons = models.TextField("Cons", blank=True)

    # Relations
    polls = models.ManyToManyField(Poll, related_name="products", blank=True)
    faqs = models.ManyToManyField(FAQ, related_name="products", blank=True)

    # Media
    logo_file = models.ImageField("Local Logo", upload_to="logos/", blank=True, null=True)
    logo_url = models.URLField("Logo URL", blank=True, null=True)
    download_button_text = models.CharField("–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è", max_length=50, default="Get App")
    download_button_url = models.URLField("–ü–æ—Å–∏–ª–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è", blank=True)

    # SEO
    seo_title = models.CharField("SEO Title", max_length=255, blank=True)
    seo_description = models.TextField("SEO Description", max_length=300, blank=True)
    seo_keywords = models.CharField("SEO Keywords", max_length=255, blank=True)
    og_image = models.URLField("OG Image (URL)", blank=True, null=True)

    # Meta
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "–ü—Ä–æ–¥—É–∫—Ç"
        verbose_name_plural = "1. –ü—Ä–æ–¥—É–∫—Ç–∏"

    def __str__(self): return self.title

    def save(self, *args, **kwargs):
        if not self.pk or (self.pk and self.__class__.objects.filter(pk=self.pk).exclude(title=self.title).exists()):
            self.slug = slugify(self.title)
        super().save(*args, **kwargs)

    def get_absolute_url(self):
        return f"https://{self.site.domain.rstrip('/')}/product/{self.slug}"

    def get_logo(self):
        return self.logo_file.url if self.logo_file else self.logo_url

    def logo_preview(self):
        logo_url = self.get_logo()
        if logo_url:
            return format_html('<img src="{}" style="max-height: 50px;" />', logo_url)
        return "‚Äî"
    logo_preview.short_description = "Logo"

    def platform_icons(self):
        icons = []
        for platform in self.store_platforms.all():
            url = platform.store_url or "#"
            icon = platform.icon_url
            icons.append(f'<a href="{url}" target="_blank" title="{platform.name}"><img src="{icon}" height="24" style="margin-right:6px;" /></a>')
        return mark_safe("".join(icons))
    platform_icons.short_description = "Store Platform"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üñºÔ∏è Screenshot
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Screenshot(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="screenshots")
    image_file = models.ImageField("Local Screenshot", upload_to="screenshots/", blank=True, null=True)
    image_url = models.URLField("Screenshot URL", blank=True, null=True)
    def get_image(self):
        return self.image_file.url if self.image_file else (self.image_url or None)

    def __str__(self):
        return ""

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üí¨ Comments
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Comment(models.Model):
    class Status(models.TextChoices):
        NEW = 'new', 'New'
        APPROVED = 'approved', '–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ'
        REJECTED = 'rejected', '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ'

    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="comments")
    name = models.CharField("Name", max_length=100, help_text="–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞")
    email = models.EmailField("Email", help_text="Email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–Ω–µ –ø—É–±–ª—ñ–∫—É—î—Ç—å—Å—è)")
    text = models.TextField("Comment Text", help_text="–¢–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è")
    status = models.CharField("–°—Ç–∞—Ç—É—Å", max_length=10, choices=Status.choices, default=Status.NEW)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = [models.Case(
            models.When(status='new', then=0),
            models.When(status='approved', then=1),
            models.When(status='rejected', then=2),
            output_field=models.IntegerField()
        )]
        verbose_name = "–ö–æ–º–µ–Ω—Ç–∞—Ä"
        verbose_name_plural = "2. –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ"

    def __str__(self):
        return f"{self.name} on {self.product.title}"


